<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="refresh" content="30"> 
  <title>ProfileDorm Usage Monitor</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    
    /* Search & Filter Panel */
    .filter-panel {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .filter-group input, .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-group input:focus {
      border-color: #22c7f0;
      outline: none;
    }
    button {
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #22c7f0;
      color: #000;
      border: none;
      border-radius: 4px;
      height: 36px;
      align-self: flex-end;
    }
    button:hover { background: #1db5d8; }
    button.danger { background: #f44336; }
    button.danger:hover { background: #d32f2f; }
    
    /* Stats */
    .stats {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    /* Machine ID sections */
    .machine-section {
      margin-bottom: 30px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
    }
    .machine-header {
      font-size: 18px;
      font-weight: bold;
      color: #22c7f0;
      margin-bottom: 10px;
      cursor: pointer;
      user-select: none;
    }
    .machine-header:hover { text-decoration: underline; }
    
    /* Table */
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
    th { background: #22c7f0; color: #000; font-weight: bold; }
    
    /* First launch bold */
    tr.first-launch { font-weight: bold; background: #e8f7ff; }
    tr.first-launch td { border-left: 4px solid #22c7f0; }
    
    .utc { font-size: 0.85em; color: #666; }
    
    /* Collapsible sections */
    .machine-content { display: block; }
    .machine-content.collapsed { display: none; }
    
    /* No results */
    .no-results {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
    }
  </style>
</head>
<body>
<h1>ProfileDorm Launch History</h1>

<!-- Search & Filter Panel -->
<div class="filter-panel">
  <div class="filter-row">
    <div class="filter-group">
      <label>Search All Fields</label>
      <input type="text" id="global-search" placeholder="Type to search..." oninput="applyFilters()">
    </div>
    
    <div class="filter-group">
      <label>Machine ID</label>
      <input type="text" id="filter-mid" placeholder="Enter machine ID..." oninput="applyFilters()">
    </div>
    
    <div class="filter-group">
      <label>Username</label>
      <input type="text" id="filter-user" placeholder="Enter username..." oninput="applyFilters()">
    </div>
    
    <div class="filter-group">
      <label>IP Address</label>
      <input type="text" id="filter-ip" placeholder="Enter IP..." oninput="applyFilters()">
    </div>
    
    <div class="filter-group">
      <label>Date From</label>
      <input type="date" id="filter-date-from" oninput="applyFilters()">
    </div>
    
    <div class="filter-group">
      <label>Date To</label>
      <input type="date" id="filter-date-to" oninput="applyFilters()">
    </div>
    
    <button onclick="clearAllFilters()">Clear Filters</button>
  </div>
  
  <div class="stats" id="stats">Loading statistics...</div>
</div>

<div id="logs-container"></div>

<script>
// Data storage
let allLogs = [];
let filteredLogs = [];
const firstLaunchTracker = new Set();

// Load logs
fetch('telemetry.jsonl?v=' + Date.now())
  .then(r => r.text())
  .then(txt => {
    const lines = txt.trim().split('\n').filter(Boolean);
    allLogs = lines.map(l => {
      const log = JSON.parse(l);
      log._timestamp = new Date(log.utc).getTime();
      return log;
    });
    filteredLogs = [...allLogs];
    
    // Identify first launches
    const seenMids = new Set();
    allLogs.forEach(log => {
      if (!seenMids.has(log.mid)) {
        firstLaunchTracker.add(log.mid);
        seenMids.add(log.mid);
      }
    });
    
    renderLogs();
    updateStats();
  });

// Filter functions
function applyFilters() {
  const globalTerm = document.getElementById('global-search').value.toLowerCase().trim();
  const midTerm = document.getElementById('filter-mid').value.toLowerCase().trim();
  const userTerm = document.getElementById('filter-user').value.toLowerCase().trim();
  const ipTerm = document.getElementById('filter-ip').value.toLowerCase().trim();
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;
  
  filteredLogs = allLogs.filter(log => {
    const dateStr = new Date(log.utc).toISOString().split('T')[0];
    
    return (!globalTerm || 
            log.mid.includes(globalTerm) || 
            log.user.toLowerCase().includes(globalTerm) || 
            log.hostname.toLowerCase().includes(globalTerm) || 
            log.ip.includes(globalTerm)) &&
           (!midTerm || log.mid.toLowerCase().includes(midTerm)) &&
           (!userTerm || log.user.toLowerCase().includes(userTerm)) &&
           (!ipTerm || log.ip.includes(ipTerm)) &&
           (!dateFrom || dateStr >= dateFrom) &&
           (!dateTo || dateStr <= dateTo);
  });
  
  renderLogs();
  updateStats();
}

function clearAllFilters() {
  document.getElementById('global-search').value = '';
  document.getElementById('filter-mid').value = '';
  document.getElementById('filter-user').value = '';
  document.getElementById('filter-ip').value = '';
  document.getElementById('filter-date-from').value = '';
  document.getElementById('filter-date-to').value = '';
  filteredLogs = [...allLogs];
  renderLogs();
  updateStats();
}

function updateStats() {
  const stats = document.getElementById('stats');
  const uniqueMids = new Set(filteredLogs.map(l => l.mid)).size;
  const uniqueUsers = new Set(filteredLogs.map(l => l.user)).size;
  const uniqueIps = new Set(filteredLogs.map(l => l.ip)).size;
  
  stats.textContent = `Showing ${filteredLogs.length} launches from ${uniqueMids} machines, ${uniqueUsers} users, ${uniqueIps} IPs`;
}

function renderLogs() {
  const container = document.getElementById('logs-container');
  
  if (filteredLogs.length === 0) {
    container.innerHTML = '<div class="no-results">No matching launches found.</div>';
    return;
  }
  
  // Group by machine ID
  const grouped = groupByMachineId(filteredLogs);
  container.innerHTML = '';
  
  const sortedEntries = Array.from(grouped.entries()).sort((a, b) => {
    const aLatest = Math.max(...a[1].map(l => l._timestamp));
    const bLatest = Math.max(...b[1].map(l => l._timestamp));
    return bLatest - aLatest;
  });
  
  sortedEntries.forEach(([mid, logs]) => {
    renderMachineSection(mid, logs, container);
  });
}

function groupByMachineId(logs) {
  const map = new Map();
  logs.forEach(log => {
    if (!map.has(log.mid)) map.set(log.mid, []);
    map.get(log.mid).push(log);
  });
  return map;
}

function renderMachineSection(mid, logs, container) {
  const section = document.createElement('div');
  section.className = 'machine-section';
  section.id = `section-${mid}`;
  
  const header = document.createElement('div');
  header.className = 'machine-header';
  header.textContent = `Machine ID: ${mid} (${logs.length} launches)`;
  header.onclick = () => toggleSection(mid);
  section.appendChild(header);
  
  const content = document.createElement('div');
  content.className = 'machine-content';
  content.id = `content-${mid}`;
  
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Launch #</th>
      <th>Local Time</th>
      <th>UTC (Raw)</th>
      <th>Windows User</th>
      <th>Hostname</th>
      <th>IP</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  
  // Sort by time (newest first)
  logs.sort((a, b) => b._timestamp - a._timestamp);
  
  logs.forEach((log, index) => {
    const row = document.createElement('tr');
    const isFirstLaunch = firstLaunchTracker.has(log.mid) && index === logs.length - 1;
    if (isFirstLaunch) row.classList.add('first-launch');
    
    const localTime = new Date(log.utc).toLocaleString();
    row.innerHTML = `
      <td>${logs.length - index}</td>
      <td>${localTime}</td>
      <td class="utc">${log.utc}</td>
      <td>${log.user}</td>
      <td>${log.hostname}</td>
      <td>${log.ip}</td>
    `;
    
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
  content.appendChild(table);
  section.appendChild(content);
  container.appendChild(section);
}

function toggleSection(mid) {
  const content = document.getElementById(`content-${mid}`);
  content.classList.toggle('collapsed');
}

function toggleAllSections() {
  const contents = document.querySelectorAll('.machine-content');
  const allCollapsed = Array.from(contents).every(c => c.classList.contains('collapsed'));
  
  contents.forEach(content => {
    if (allCollapsed) {
      content.classList.remove('collapsed');
    } else {
      content.classList.add('collapsed');
    }
  });
}

function clearLogs() {
  if (confirm('⚠️ This clears the display only. To delete from GitHub, edit telemetry.jsonl manually.\n\nContinue?')) {
    document.getElementById('logs-container').innerHTML = '<div class="no-results">Logs cleared. Refresh page to reload.</div>';
    document.getElementById('stats').textContent = 'Showing 0 launches';
  }
}
</script>
</body>
</html>
