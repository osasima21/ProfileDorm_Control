<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ProfileDorm Usage Monitor</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    .controls { margin-bottom: 20px; }
    button { padding: 10px 20px; font-size: 14px; cursor: pointer; background: #22c7f0; color: #000; border: none; border-radius: 4px; }
    button:hover { background: #1db5d8; }
    
    /* Machine ID sections */
    .machine-section { margin-bottom: 30px; border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white; }
    .machine-header { font-size: 18px; font-weight: bold; color: #22c7f0; margin-bottom: 10px; cursor: pointer; }
    .machine-header:hover { text-decoration: underline; }
    
    /* Table styling */
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
    th { background: #22c7f0; color: #000; font-weight: bold; }
    
    /* First launch bold */
    tr.first-launch { font-weight: bold; background: #e8f7ff; }
    tr.first-launch td { border-left: 4px solid #22c7f0; }
    
    .utc { font-size: 0.85em; color: #666; }
    
    /* Collapsible sections */
    .machine-content { display: block; }
    .machine-content.collapsed { display: none; }
  </style>
</head>
<body>
<h1>ProfileDorm Launch History</h1>

<div class="controls">
  <button onclick="clearLogs()">üóëÔ∏è Clear All Logs (Local Only)</button>
  <button onclick="toggleAllSections()">üìÇ Expand/Collapse All</button>
  
  <!-- Search and Filter Controls -->
  <div>
    <label for="search-term">Search:</label>
    <input type="text" id="search-term" placeholder="Enter search term">
  </div>
  
  <div>
    <label for="filter-by">Filter By:</label>
    <select id="filter-by">
      <option value="all">All Fields</option>
      <option value="mid">Machine ID</option>
      <option value="user">Username</option>
      <option value="ip">IP Address</option>
    </select>
  </div>
  
  <button onclick="applyFilters()">üîç Apply Filters</button>
</div>

<div id="logs-container"></div>

<script>
// Global variables to store logs and filtered results
let allLogs = [];
let filteredLogs = [];

// Function to apply filters and search
function applyFilters() {
  const searchTerm = document.getElementById('search-term').value.toLowerCase();
  const filterBy = document.getElementById('filter-by').value;

  filteredLogs = allLogs.filter(log => {
    switch (filterBy) {
      case 'all':
        return JSON.stringify(log).toLowerCase().includes(searchTerm);
      case 'mid':
        return log.mid.toLowerCase().includes(searchTerm);
      case 'user':
        return log.user.toLowerCase().includes(searchTerm);
      case 'ip':
        return log.ip.toLowerCase().includes(searchTerm);
      default:
        return true;
    }
  });

  renderGroupedLogs(groupByMachineId(filteredLogs));
}

// Function to render grouped logs
function renderGroupedLogs(grouped) {
  const container = document.getElementById('logs-container');
  container.innerHTML = '';

  Array.from(grouped.entries()).forEach(([mid, logs]) => {
    renderMachineSection(mid, logs, container);
  });
}

// Function to group logs by machine ID
function groupByMachineId(logs) {
  const map = new Map();
  logs.forEach(log => {
    if (!map.has(log.mid)) map.set(log.mid, []);
    map.get(log.mid).push(log);
  });
  return map;
}

// Function to render a machine section
function renderMachineSection(mid, logs, container) {
  const section = document.createElement('div');
  section.className = 'machine-section';
  section.id = `section-${mid}`;

  const header = document.createElement('div');
  header.className = 'machine-header';
  header.textContent = `Machine ID: ${mid} (${logs.length} launches)`;
  header.onclick = () => toggleSection(mid);
  section.appendChild(header);

  const content = document.createElement('div');
  content.className = 'machine-content';
  content.id = `content-${mid}`;

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Launch #</th>
      <th>Local Time</th>
      <th>UTC (Raw)</th>
      <th>Windows User</th>
      <th>Hostname</th>
      <th>IP</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  logs.forEach((log, index) => {
    const row = document.createElement('tr');
    const isFirstLaunch = index === 0;
    if (isFirstLaunch) row.classList.add('first-launch');
    const localTime = new Date(log.utc).toLocaleString();
    row.innerHTML = `
      <td>${logs.length - index}</td>
      <td>${localTime}</td>
      <td class="utc">${log.utc}</td>
      <td>${log.user}</td>
      <td>${log.hostname}</td>
      <td>${log.ip}</td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  content.appendChild(table);
  section.appendChild(content);
  container.appendChild(section);
}

// Function to toggle a section
function toggleSection(mid) {
  const content = document.getElementById(`content-${mid}`);
  content.classList.toggle('collapsed');
}

// Function to toggle all sections
function toggleAllSections() {
  const contents = document.querySelectorAll('.machine-content');
  const allCollapsed = Array.from(contents).every(c => c.classList.contains('collapsed'));
  contents.forEach(content => {
    if (allCollapsed) {
      content.classList.remove('collapsed');
    } else {
      content.classList.add('collapsed');
    }
  });
}

// Function to clear logs
function clearLogs() {
  if (confirm('‚ö†Ô∏è This will clear the display only. To permanently delete from GitHub, you must edit telemetry.jsonl manually.\n\nContinue?')) {
    document.getElementById('logs-container').innerHTML = '<p style="color: #999;">Logs cleared. Refresh page to reload.</p>';
  }
}

// Load and process logs
fetch('telemetry.jsonl?v=' + Date.now())
  .then(r => r.text())
  .then(txt => {
    const lines = txt.trim().split('\n').filter(Boolean);
    allLogs = lines.map(l => JSON.parse(l));
    applyFilters(); // Apply initial filters
  });
</script>
</body>
</html>
