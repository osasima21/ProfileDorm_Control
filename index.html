<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="refresh" content="30"> 
  <title>ProfileDorm Usage Monitor</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    .controls { margin-bottom: 20px; }
    button { padding: 10px 20px; font-size: 14px; cursor: pointer; background: #22c7f0; color: #000; border: none; border-radius: 4px; }
    button:hover { background: #1db5d8; }
    
    /* Machine ID sections */
    .machine-section { margin-bottom: 30px; border: 2px solid #ddd; border-radius: 8px; padding: 15px; background: white; }
    .machine-header { font-size: 18px; font-weight: bold; color: #22c7f0; margin-bottom: 10px; cursor: pointer; }
    .machine-header:hover { text-decoration: underline; }
    
    /* Table styling */
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
    th { background: #22c7f0; color: #000; font-weight: bold; }
    
    /* First launch bold */
    tr.first-launch { font-weight: bold; background: #e8f7ff; }
    tr.first-launch td { border-left: 4px solid #22c7f0; }
    
    .utc { font-size: 0.85em; color: #666; }
    
    /* Collapsible sections */
    .machine-content { display: block; }
    .machine-content.collapsed { display: none; }
  </style>
</head>
<body>
<h1>ProfileDorm Launch History</h1>

<div class="controls">
  <button onclick="clearLogs()">üóëÔ∏è Clear All Logs (Local Only)</button>
  <button onclick="toggleAllSections()">üìÇ Expand/Collapse All</button>
</div>

<div id="logs-container"></div>

<script>
// Track first launches per machine ID
const firstLaunchTracker = new Set();
let allLogs = [];

// Load and process logs
fetch('telemetry.jsonl?v=' + Date.now())
  .then(r => r.text())
  .then(txt => {
    const lines = txt.trim().split('\n').filter(Boolean);
    allLogs = lines.map(l => JSON.parse(l));
    
    // Group by machine ID
    const grouped = groupByMachineId(allLogs);
    renderGroupedLogs(grouped);
  });

function groupByMachineId(logs) {
  const map = new Map();
  logs.forEach(log => {
    if (!map.has(log.mid)) map.set(log.mid, []);
    map.get(log.mid).push(log);
  });
  return map;
}

function renderGroupedLogs(grouped) {
  const container = document.getElementById('logs-container');
  container.innerHTML = '';
  
  // Sort machine IDs by most recent activity
  const sortedEntries = Array.from(grouped.entries()).sort((a, b) => {
    const aLatest = Math.max(...a[1].map(l => new Date(l.utc).getTime()));
    const bLatest = Math.max(...b[1].map(l => new Date(l.utc).getTime()));
    return bLatest - aLatest;
  });
  
  sortedEntries.forEach(([mid, logs]) => {
    renderMachineSection(mid, logs, container);
  });
}

function renderMachineSection(mid, logs, container) {
  const section = document.createElement('div');
  section.className = 'machine-section';
  section.id = `section-${mid}`;
  
  // Header with machine ID and count
  const header = document.createElement('div');
  header.className = 'machine-header';
  header.textContent = `Machine ID: ${mid} (${logs.length} launches)`;
  header.onclick = () => toggleSection(mid);
  section.appendChild(header);
  
  // Content div
  const content = document.createElement('div');
  content.className = 'machine-content';
  content.id = `content-${mid}`;
  
  // Table
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Launch #</th>
      <th>Local Time</th>
      <th>UTC (Raw)</th>
      <th>Windows User</th>
      <th>Hostname</th>
      <th>IP</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  
  // Sort logs by time (newest first)
  logs.sort((a, b) => new Date(b.utc) - new Date(a.utc));
  
  logs.forEach((log, index) => {
    const row = document.createElement('tr');
    
    // Check if this is the first launch for this machine
    const isFirstLaunch = !firstLaunchTracker.has(log.mid);
    if (isFirstLaunch) {
      firstLaunchTracker.add(log.mid);
      row.classList.add('first-launch');
    }
    
    const localTime = new Date(log.utc).toLocaleString();
    
    row.innerHTML = `
      <td>${logs.length - index}</td>
      <td>${localTime}</td>
      <td class="utc">${log.utc}</td>
      <td>${log.user}</td>
      <td>${log.hostname}</td>
      <td>${log.ip}</td>
    `;
    
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
  content.appendChild(table);
  section.appendChild(content);
  container.appendChild(section);
}

function toggleSection(mid) {
  const content = document.getElementById(`content-${mid}`);
  content.classList.toggle('collapsed');
}

function toggleAllSections() {
  const contents = document.querySelectorAll('.machine-content');
  const allCollapsed = Array.from(contents).every(c => c.classList.contains('collapsed'));
  
  contents.forEach(content => {
    if (allCollapsed) {
      content.classList.remove('collapsed');
    } else {
      content.classList.add('collapsed');
    }
  });
}

function clearLogs() {
  if (confirm('‚ö†Ô∏è This will clear the display only. To permanently delete from GitHub, you must edit telemetry.jsonl manually.\n\nContinue?')) {
    document.getElementById('logs-container').innerHTML = '<p style="color: #999;">Logs cleared. Refresh page to reload.</p>';
  }
}
</script>
</body>
</html>
